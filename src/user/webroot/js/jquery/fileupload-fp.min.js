(function(a){"use strict";if(typeof define==="function"&&define.amd){define(["jquery","load-image","canvas-to-blob","./jquery.fileupload"],a)}else{a(window.jQuery,window.loadImage)}})(function(a,b){"use strict";a.widget("blueimpFP.fileupload",a.blueimp.fileupload,{options:{process:[],add:function(b,c){a(this).fileupload("process",c).done(function(){c.submit()})}},processActions:{load:function(c,d){var e=this,f=c.files[c.index],g=a.Deferred();if(window.HTMLCanvasElement&&window.HTMLCanvasElement.prototype.toBlob&&(a.type(d.maxFileSize)!=="number"||f.size<d.maxFileSize)&&(!d.fileTypes||d.fileTypes.test(f.type))){b(f,function(a){c.canvas=a;g.resolveWith(e,[c])},{canvas:true})}else{g.rejectWith(e,[c])}return g.promise()},resize:function(a,c){if(a.canvas){var d=b.scale(a.canvas,c);if(d.width!==a.canvas.width||d.height!==a.canvas.height){a.canvas=d;a.processed=true}}return a},save:function(b,c){if(!b.canvas||!b.processed){return b}var d=this,e=b.files[b.index],f=e.name,g=a.Deferred(),h=function(a){if(!a.name){if(e.type===a.type){a.name=e.name}else if(e.name){a.name=e.name.replace(/\..+$/,"."+a.type.substr(6))}}b.files[b.index]=a;g.resolveWith(d,[b])};if(b.canvas.mozGetAsFile){h(b.canvas.mozGetAsFile(/^image\/(jpeg|png)$/.test(e.type)&&f||(f&&f.replace(/\..+$/,"")||"blob")+".png",e.type))}else{b.canvas.toBlob(h,e.type)}return g.promise()}},_processFile:function(b,c,d){var e=this,f=a.Deferred().resolveWith(e,[{files:b,index:c}]),g=f.promise();e._processing+=1;a.each(d.process,function(a,b){g=g.pipe(function(a){return e.processActions[b.action].call(this,a,b)})});g.always(function(){e._processing-=1;if(e._processing===0){e.element.removeClass("fileupload-processing")}});if(e._processing===1){e.element.addClass("fileupload-processing")}return g},process:function(b){var c=this,d=a.extend({},this.options,b);if(d.process&&d.process.length&&this._isXHRUpload(d)){a.each(b.files,function(e,f){c._processingQueue=c._processingQueue.pipe(function(){var f=a.Deferred();c._processFile(b.files,e,d).always(function(){f.resolveWith(c)});return f.promise()})})}return this._processingQueue},_create:function(){a.blueimp.fileupload.prototype._create.call(this);this._processing=0;this._processingQueue=a.Deferred().resolveWith(this).promise()}})})