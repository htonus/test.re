(function(a){"use strict";if(typeof define==="function"&&define.amd){define(["jquery","tmpl","load-image","./jquery.fileupload-fp"],a)}else{a(window.jQuery,window.tmpl,window.loadImage)}})(function(a,b,c){"use strict";var d=(a.blueimpFP||a.blueimp).fileupload;a.widget("blueimpUI.fileupload",d,{options:{autoUpload:false,maxNumberOfFiles:undefined,maxFileSize:undefined,minFileSize:undefined,acceptFileTypes:/.+$/i,previewSourceFileTypes:/^image\/(gif|jpeg|png)$/,previewSourceMaxFileSize:5e6,previewMaxWidth:80,previewMaxHeight:80,previewAsCanvas:true,uploadTemplateId:"template-upload",downloadTemplateId:"template-download",filesContainer:undefined,prependFiles:false,dataType:"json",add:function(b,c){var d=a(this).data("fileupload"),e=d.options,f=c.files;a(this).fileupload("process",c).done(function(){d._adjustMaxNumberOfFiles(-f.length);c.maxNumberOfFilesAdjusted=true;c.files.valid=c.isValidated=d._validate(f);c.context=d._renderUpload(f).data("data",c);e.filesContainer[e.prependFiles?"prepend":"append"](c.context);d._renderPreviews(f,c.context);d._forceReflow(c.context);d._transition(c.context).done(function(){if(d._trigger("added",b,c)!==false&&(e.autoUpload||c.autoUpload)&&c.autoUpload!==false&&c.isValidated){c.submit()}})})},send:function(b,c){var d=a(this).data("fileupload");if(!c.isValidated){if(!c.maxNumberOfFilesAdjusted){d._adjustMaxNumberOfFiles(-c.files.length);c.maxNumberOfFilesAdjusted=true}if(!d._validate(c.files)){return false}}if(c.context&&c.dataType&&c.dataType.substr(0,6)==="iframe"){c.context.find(".progress").addClass(!a.support.transition&&"progress-animated").attr("aria-valuenow",100).find(".bar").css("width","100%")}return d._trigger("sent",b,c)},done:function(b,c){var d=a(this).data("fileupload"),e;if(c.context){c.context.each(function(f){var g=a.isArray(c.result)&&c.result[f]||{error:"emptyResult"};if(g.error){d._adjustMaxNumberOfFiles(1)}d._transition(a(this)).done(function(){var f=a(this);e=d._renderDownload([g]).replaceAll(f);d._forceReflow(e);d._transition(e).done(function(){c.context=a(this);d._trigger("completed",b,c)})})})}else{if(a.isArray(c.result)){a.each(c.result,function(a,b){if(c.maxNumberOfFilesAdjusted&&b.error){d._adjustMaxNumberOfFiles(1)}else if(!c.maxNumberOfFilesAdjusted&&!b.error){d._adjustMaxNumberOfFiles(-1)}});c.maxNumberOfFilesAdjusted=true}e=d._renderDownload(c.result).appendTo(d.options.filesContainer);d._forceReflow(e);d._transition(e).done(function(){c.context=a(this);d._trigger("completed",b,c)})}},fail:function(b,c){var d=a(this).data("fileupload"),e;if(c.maxNumberOfFilesAdjusted){d._adjustMaxNumberOfFiles(c.files.length)}if(c.context){c.context.each(function(f){if(c.errorThrown!=="abort"){var g=c.files[f];g.error=g.error||c.errorThrown||true;d._transition(a(this)).done(function(){var f=a(this);e=d._renderDownload([g]).replaceAll(f);d._forceReflow(e);d._transition(e).done(function(){c.context=a(this);d._trigger("failed",b,c)})})}else{d._transition(a(this)).done(function(){a(this).remove();d._trigger("failed",b,c)})}})}else if(c.errorThrown!=="abort"){c.context=d._renderUpload(c.files).appendTo(d.options.filesContainer).data("data",c);d._forceReflow(c.context);d._transition(c.context).done(function(){c.context=a(this);d._trigger("failed",b,c)})}else{d._trigger("failed",b,c)}},progress:function(a,b){if(b.context){var c=parseInt(b.loaded/b.total*100,10);b.context.find(".progress").attr("aria-valuenow",c).find(".bar").css("width",c+"%")}},progressall:function(b,c){var d=a(this),e=parseInt(c.loaded/c.total*100,10),f=d.find(".fileupload-progress"),g=f.find(".progress-extended");if(g.length){g.html(d.data("fileupload")._renderExtendedProgress(c))}f.find(".progress").attr("aria-valuenow",e).find(".bar").css("width",e+"%")},start:function(b){var c=a(this).data("fileupload");c._transition(a(this).find(".fileupload-progress")).done(function(){c._trigger("started",b)})},stop:function(b){var c=a(this).data("fileupload");c._transition(a(this).find(".fileupload-progress")).done(function(){a(this).find(".progress").attr("aria-valuenow","0").find(".bar").css("width","0%");a(this).find(".progress-extended").html("Â ");c._trigger("stopped",b)})},destroy:function(b,c){var d=a(this).data("fileupload");if(c.url){a.ajax(c);d._adjustMaxNumberOfFiles(1)}d._transition(c.context).done(function(){a(this).remove();d._trigger("destroyed",b,c)})}},_enableDragToDesktop:function(){var b=a(this),c=b.prop("href"),d=b.prop("download"),e="application/octet-stream";b.bind("dragstart",function(a){try{a.originalEvent.dataTransfer.setData("DownloadURL",[e,d,c].join(":"))}catch(b){}})},_adjustMaxNumberOfFiles:function(a){if(typeof this.options.maxNumberOfFiles==="number"){this.options.maxNumberOfFiles+=a;if(this.options.maxNumberOfFiles<1){this._disableFileInputButton()}else{this._enableFileInputButton()}}},_formatFileSize:function(a){if(typeof a!=="number"){return""}if(a>=1e9){return(a/1e9).toFixed(2)+" GB"}if(a>=1e6){return(a/1e6).toFixed(2)+" MB"}return(a/1e3).toFixed(2)+" KB"},_formatBitrate:function(a){if(typeof a!=="number"){return""}if(a>=1e9){return(a/1e9).toFixed(2)+" Gbit/s"}if(a>=1e6){return(a/1e6).toFixed(2)+" Mbit/s"}if(a>=1e3){return(a/1e3).toFixed(2)+" kbit/s"}return a+" bit/s"},_formatTime:function(a){var b=new Date(a*1e3),c=parseInt(a/86400,10);c=c?c+"d ":"";return c+("0"+b.getUTCHours()).slice(-2)+":"+("0"+b.getUTCMinutes()).slice(-2)+":"+("0"+b.getUTCSeconds()).slice(-2)},_formatPercentage:function(a){return(a*100).toFixed(2)+" %"},_renderExtendedProgress:function(a){return this._formatBitrate(a.bitrate)+" | "+this._formatTime((a.total-a.loaded)*8/a.bitrate)+" | "+this._formatPercentage(a.loaded/a.total)+" | "+this._formatFileSize(a.loaded)+" / "+this._formatFileSize(a.total)},_hasError:function(a){if(a.error){return a.error}if(this.options.maxNumberOfFiles<0){return"maxNumberOfFiles"}if(!(this.options.acceptFileTypes.test(a.type)||this.options.acceptFileTypes.test(a.name))){return"acceptFileTypes"}if(this.options.maxFileSize&&a.size>this.options.maxFileSize){return"maxFileSize"}if(typeof a.size==="number"&&a.size<this.options.minFileSize){return"minFileSize"}return null},_validate:function(b){var c=this,d=!!b.length;a.each(b,function(a,b){b.error=c._hasError(b);if(b.error){d=false}});return d},_renderTemplate:function(b,c){if(!b){return a()}var d=b({files:c,formatFileSize:this._formatFileSize,options:this.options});if(d instanceof a){return d}return a(this.options.templatesContainer).html(d).children()},_renderPreview:function(b,d){var e=this,f=this.options,g=a.Deferred();return(c&&c(b,function(b){d.append(b);e._forceReflow(d);e._transition(d).done(function(){g.resolveWith(d)});if(!a.contains(document.body,d[0])){g.resolveWith(d)}},{maxWidth:f.previewMaxWidth,maxHeight:f.previewMaxHeight,canvas:f.previewAsCanvas})||g.resolveWith(d))&&g},_renderPreviews:function(b,c){var d=this,e=this.options;c.find(".preview span").each(function(c,f){var g=b[c];if(e.previewSourceFileTypes.test(g.type)&&(a.type(e.previewSourceMaxFileSize)!=="number"||g.size<e.previewSourceMaxFileSize)){d._processingQueue=d._processingQueue.pipe(function(){var b=a.Deferred();d._renderPreview(g,a(f)).done(function(){b.resolveWith(d)});return b.promise()})}});return this._processingQueue},_renderUpload:function(a){return this._renderTemplate(this.options.uploadTemplate,a)},_renderDownload:function(a){return this._renderTemplate(this.options.downloadTemplate,a).find("a[download]").each(this._enableDragToDesktop).end()},_startHandler:function(b){b.preventDefault();var c=a(this),d=c.closest(".template-upload"),e=d.data("data");if(e&&e.submit&&!e.jqXHR&&e.submit()){c.prop("disabled",true)}},_cancelHandler:function(b){b.preventDefault();var c=a(this).closest(".template-upload"),d=c.data("data")||{};if(!d.jqXHR){d.errorThrown="abort";b.data.fileupload._trigger("fail",b,d)}else{d.jqXHR.abort()}},_deleteHandler:function(b){b.preventDefault();var c=a(this);b.data.fileupload._trigger("destroy",b,{context:c.closest(".template-download"),url:c.attr("data-url"),type:c.attr("data-type")||"DELETE",dataType:b.data.fileupload.options.dataType})},_forceReflow:function(b){return a.support.transition&&b.length&&b[0].offsetWidth},_transition:function(b){var c=a.Deferred();if(a.support.transition&&b.hasClass("fade")){b.bind(a.support.transition.end,function(d){if(d.target===b[0]){b.unbind(a.support.transition.end);c.resolveWith(b)}}).toggleClass("in")}else{b.toggleClass("in");c.resolveWith(b)}return c},_initButtonBarEventHandlers:function(){var b=this.element.find(".fileupload-buttonbar"),c=this.options.filesContainer,d=this.options.namespace;b.find(".start").bind("click."+d,function(a){a.preventDefault();c.find(".start button").click()});b.find(".cancel").bind("click."+d,function(a){a.preventDefault();c.find(".cancel button").click()});b.find(".delete").bind("click."+d,function(a){a.preventDefault();c.find(".delete input:checked").siblings("button").click();b.find(".toggle").prop("checked",false)});b.find(".toggle").bind("change."+d,function(b){c.find(".delete input").prop("checked",a(this).is(":checked"))})},_destroyButtonBarEventHandlers:function(){this.element.find(".fileupload-buttonbar button").unbind("click."+this.options.namespace);this.element.find(".fileupload-buttonbar .toggle").unbind("change."+this.options.namespace)},_initEventHandlers:function(){d.prototype._initEventHandlers.call(this);var a={fileupload:this};this.options.filesContainer.delegate(".start button","click."+this.options.namespace,a,this._startHandler).delegate(".cancel button","click."+this.options.namespace,a,this._cancelHandler).delegate(".delete button","click."+this.options.namespace,a,this._deleteHandler);this._initButtonBarEventHandlers()},_destroyEventHandlers:function(){var a=this.options;this._destroyButtonBarEventHandlers();a.filesContainer.undelegate(".start button","click."+a.namespace).undelegate(".cancel button","click."+a.namespace).undelegate(".delete button","click."+a.namespace);d.prototype._destroyEventHandlers.call(this)},_enableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",false).parent().removeClass("disabled")},_disableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",true).parent().addClass("disabled")},_initTemplates:function(){var a=this.options;a.templatesContainer=document.createElement(a.filesContainer.prop("nodeName"));if(b){if(a.uploadTemplateId){a.uploadTemplate=b(a.uploadTemplateId)}if(a.downloadTemplateId){a.downloadTemplate=b(a.downloadTemplateId)}}},_initFilesContainer:function(){var b=this.options;if(b.filesContainer===undefined){b.filesContainer=this.element.find(".files")}else if(!(b.filesContainer instanceof a)){b.filesContainer=a(b.filesContainer)}},_stringToRegExp:function(a){var b=a.split("/"),c=b.pop();b.shift();return new RegExp(b.join("/"),c)},_initRegExpOptions:function(){var b=this.options;if(a.type(b.acceptFileTypes)==="string"){b.acceptFileTypes=this._stringToRegExp(b.acceptFileTypes)}if(a.type(b.previewSourceFileTypes)==="string"){b.previewSourceFileTypes=this._stringToRegExp(b.previewSourceFileTypes)}},_initSpecialOptions:function(){d.prototype._initSpecialOptions.call(this);this._initFilesContainer();this._initTemplates();this._initRegExpOptions()},_create:function(){d.prototype._create.call(this);this._refreshOptionsList.push("filesContainer","uploadTemplateId","downloadTemplateId");if(!a.blueimpFP){this._processingQueue=a.Deferred().resolveWith(this).promise();this.process=function(){return this._processingQueue}}},enable:function(){d.prototype.enable.call(this);this.element.find("input, button").prop("disabled",false);this._enableFileInputButton()},disable:function(){this.element.find("input, button").prop("disabled",true);this._disableFileInputButton();d.prototype.disable.call(this)}})})