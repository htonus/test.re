<?php
/*
 * $Id$
 */


	$partViewer->view('_parts/js', Model::create()->set('name', 'selector'));
	$partViewer->view('_parts/js', Model::create()->set('name', 'jquery/ui-widget.min'));
	$partViewer->view('_parts/js', Model::create()->set('name', 'tmpl.min'));
	$partViewer->view('_parts/js', Model::create()->set('name', 'jquery/load-image.min'));
	$partViewer->view('_parts/js', Model::create()->set('name', 'jquery/canvas-to-blob.min'));
	$partViewer->view('_parts/js', Model::create()->set('name', 'jquery/iframe-transport.min'));
	$partViewer->view('_parts/js', Model::create()->set('name', 'jquery/fileupload.min'));
//	$partViewer->view('_parts/js', Model::create()->set('name', '/get/js/locale'));

	$bedsList = array();
	for ($number = 1; $number < 6; $number ++)
		$bedsList[$number] = $number;

	$priceList = array();
	for ($number = 100000; $number < 500000; $number += 100000)
		$priceList[$number] = $number;

?>

<div class="container_24">

	<!-- Main Form -->
	<div class="g_16">

		<form
			action="/property/<?=$form->getValue('id') ? 'save' : 'add'?>/<?=$form->getActualValue('offer')->getName()?>"
			id="fileupload"
			method="POST"
			enctype="multipart/form-data"
		>

		<div class="g_10 alpha">
<?php
	$partViewer->view(
		'_parts/form/input',
		Model::create()->
			set('params', array(
				'name'	=> 'name',
				'label'	=> "Title",
			))
	);
?>
		</div>
		<div class="g_6 omega">
<?php
	$partViewer->view(
		'_parts/form/input',
		Model::create()->
			set('params', array(
				'name'	=> 'city',
				'label'	=> "Location",
			))
	);
?>
		</div>
		<div class="clear"></div>

		<div class="g_4 alpha">
<?php
	$partViewer->view(
		'_parts/form/select',
		Model::create()->
			set('params', array(
				'name'	=> 'property',
				'label'	=> "Property type",
				'list'	=> $propertyTypeList,
				'value'	=> PropertyType::PROPERTY,
			))
	);
?>
		</div>
		<div class="g_3">
<?php
	$partViewer->view(
		'_parts/form/select',
		Model::create()->
			set('params', array(
				'name'	=> 'type['.FeatureType::BEDROOMS.']',
				'label'	=> "Bedrooms",
				'list'	=> $bedsList,
				'topOption'	=> 'Choose...',
			))
	);
?>
		</div>
		<div class="g_3">
<?php
	$partViewer->view(
		'_parts/form/select',
		Model::create()->
			set('params', array(
				'name'	=> 'type['.FeatureType::TOYLETS.']',
				'label'	=> "Toylets",
				'list'	=> $bedsList,
				'topOption'	=> 'Choose...',
			))
	);
?>
		</div>
		<div class="g_3">
<?php
	$partViewer->view(
		'_parts/form/input',
		Model::create()->
			set('params', array(
				'name'	=> 'type['.FeatureType::AREA.']',
				'label'	=> "Area",
				'class'	=> 'area'
			))
	);
?>
		</div>
		<div class="g_3 omega">
<?php
	$partViewer->view(
		'_parts/form/select',
		Model::create()->
			set('params', array(
				'name'	=> 'type['.FeatureType::PARKING.']',
				'label'	=> "Parking places",
				'list'	=> $bedsList,
				'topOption'	=> 'Choose...',
			))
	);
?>
		</div>
		<div class="clear"></div>

		<div class="g_16 alpha omega">
			<fieldset id="images">
				<input type="file" name="file" id="fileButton" multiple="true" style="display: none;"/>
				<label for="images">Property Images (drag & drop in the field below or <span id="fileTrigger">press here</span> to add)</label>
				<ul class="input" id="fileContainer"></ul>
			</fieldset>
		</div>

		</form>
	</div>

	<!-- Useful Hints -->
	<div class="g_10">

	</div>

</div>

<script type="text/javascript">
	
$(document).ready(function(){
	ImageLoader.init();
});

var ImageLoader = {
	trigger:	'#fileTrigger',
	button:		'#fileButton',
	container:	'#fileContainer',
	form:		'#fileupload',
	
	previewWidth:	180,
	previewHeight:	120,
	
	fileList:	[],

	init: function(){
		$(ImageLoader.trigger).click(function(){
			$(ImageLoader.button).click();
		});

		$(ImageLoader.container).bind({
			dragenter: function(){
				$(ImageLoader.container).addClass('highlite')
				return false;
			},
			dragover: function(){
				return false;
			},
			dragleave: function(){
				$(ImageLoader.container).removeClass('highlite')
				return false;
			},
			drop: function(e){
				var dt = e.originalEvent.dataTransfer;
				$(ImageLoader.container).removeClass('highlite')
				$.each(dt.files, function(i, file){
					ImageLoader.addFile(file);
				});
				return false;
			}
		});
		
		$(ImageLoader.form).fileupload({
			progress: function (e, data) {
				var progress = parseInt(data.loaded / data.total * 100, 10);
				$('.uploadFile .bar').css(
					'width',
					progress + '%'
				);
			},
			add: function (e, data) {
				$.each(data.files, function(i, file){
					if (file.type.match(/^image.*/)) {
						ImageLoader.addFile(file);
					}
				});
			},

			done: function (e, data) {
				alert('done');
			}
		});

	},

	addFile: function(file){
		file.id = ImageLoader.fileList.length;
		ImageLoader.fileList[file.id] = file;
		
		window.loadImage(
			file,
			function (img) {
				var div = $(tmpl('tmplUpload', {'file': file})).appendTo(ImageLoader.container)
				$('.preview', div)
					.css({
						'padding': ''
							+ parseInt((ImageLoader.previewHeight - img.height) / 2) + ' '
							+ parseInt((ImageLoader.previewWidth - img.width) / 2)
					})
					.html(img);
				$('.drop', div).click(function(){
					ImageLoader.fileList = $.grep(ImageLoader.fileList, function(_file){
						return _file.id != file.id;
					});
					div.remove();
					ImageLoader.update();
				});
				ImageLoader.update();
			},
			{
				maxWidth:	ImageLoader.previewWidth,
				maxHeight:	ImageLoader.previewHeight
			}
		);
	},

	update: function(){
		if ($(ImageLoader.fileList).size() > 3) {
			$('#fileContainer').height(420);
			
			if ($(ImageLoader.fileList).size() > 6) {
				$('#fileContainer').css('overflow-y', 'scroll');
			} else {
				$('#fileContainer').css('overflow', 'hidden');
			}
		} else {
			$('#fileContainer').animate({height: 220});
		}
	},
	
	upload: function(){
		
	},
	
	uploadFile: function(){
		
	}

}
</script>

<script type="text/x-tmpl" id="tmplUpload">
<li class="file" id="file_{%='' + o.file.id%}">
	<div class="name">{%=o.file.name%} ({% if (o.file.size >> 20 > 0) print((o.file.size >> 20) + 'Mb'); else print((o.file.size >> 10) + 'kb'); %})</div>
	<div class="button drop"><b>x</b></div>
	<div class="clear"></div>
	
	<div class="preview"></div>
	<div class="input">
		<input type="text" name="city" value="">
	</div>
	
</li>
</script>
